<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Scan & Gửi Google Sheet</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    .wrapper {
      display: flex;
      flex-direction: row;
      width: 200vw;
      transition: transform 0.3s ease;
    }
    .panel {
      width: 100vw;
      height: 100vh;
      overflow-y: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    textarea {
      width: 100%;
      height: 100px;
      resize: none;
      overflow-y: auto;
    }
    video {
      width: 100%;
      max-height: 300px;
      background: black;
    }
    #data-table {
      width: 100%;
      border-collapse: collapse;
    }
    #data-table th, #data-table td {
      border: 1px solid #ccc;
      padding: 6px;
    }
    select, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
    }
  </style>
</head>
<body>
<div class="wrapper" id="wrapper">
  <div class="panel" id="scan-panel">
    <h3>Chọn người dùng:</h3>
    <select id="userSelect"></select>
    <video id="video" playsinline></video>
    <textarea id="resultArea" placeholder="Kết quả quét..."></textarea>
    <button onclick="submitData()">Gửi</button>
    <div id="statusMsg"></div>
  </div>
  <div class="panel">
    <h3>Dữ liệu đã quét</h3>
    <table id="data-table">
      <thead><tr><th>Thời gian</th><th>Mã</th><th>Người</th></tr></thead>
      <tbody id="data-body"></tbody>
    </table>
  </div>
</div>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbxgdO3DI_3GB-4xV8Zv8d5aG7hdBB_j7roe7zoy9Tx-DMRp_RkTGSqqUqAufuMOOrM/exec";
let codeReader;
let scanned = new Set();
const wrapper = document.getElementById("wrapper");
let currentPanel = 0, startX = 0;

async function loadUsers() {
  let res = await fetch(`${sheetAPI}?action=getUsers`);
  let json = await res.json();
  let select = document.getElementById("userSelect");
  select.innerHTML = json.users.map(name => `<option>${name}</option>`).join("");
}

function startScanner() {
  codeReader = new ZXing.BrowserMultiFormatReader();
  codeReader.listVideoInputDevices().then(videoInputDevices => {
    let backCamera = videoInputDevices.find(device => /back|environment/i.test(device.label)) || videoInputDevices[0];
    return codeReader.decodeFromVideoDevice(backCamera.deviceId, "video", (result, err) => {
      if (result) {
        let val = result.text.trim();
        if (!scanned.has(val)) {
          scanned.add(val);
          let area = document.getElementById("resultArea");
          area.value += val + "\n";
        }
      }
    });
  });
}

function submitData() {
  let codes = document.getElementById("resultArea").value.trim().split("\n").filter(n => n);
  if (!codes.length) return alert("Không có mã để gửi.");
  let user = document.getElementById("userSelect").value;
  fetch(sheetAPI, {
    method: "POST",
    body: JSON.stringify({codes, user}),
    headers: {"Content-Type": "application/json"}
  }).then(res => res.json()).then(res => {
    if (res.status === "ok") {
      document.getElementById("statusMsg").innerText = `Gửi thành công ${res.added} mã.`;
      document.getElementById("resultArea").value = "";
      scanned.clear();
    } else {
      alert("Gửi thất bại.");
    }
  });
}

wrapper.addEventListener("touchstart", e => startX = e.touches[0].clientX);
wrapper.addEventListener("touchend", e => {
  let deltaX = e.changedTouches[0].clientX - startX;
  if (deltaX < -50 && currentPanel === 0) currentPanel = 1;
  else if (deltaX > 50 && currentPanel === 1) currentPanel = 0;
  wrapper.style.transform = `translateX(-${currentPanel * 100}vw)`;
});

function updateTable() {
  fetch(`${sheetAPI}?action=getData`)
    .then(res => res.json())
    .then(json => {
      if (json.status !== "ok") return;
      const tbody = document.getElementById("data-body");
      tbody.innerHTML = "";
      json.data.slice(1).reverse().forEach(row => {
        let tr = document.createElement("tr");
        row.forEach(cell => {
          let td = document.createElement("td");
          td.innerText = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    });
}

loadUsers();
startScanner();
setInterval(updateTable, 10000);
updateTable();
</script>
</body>
</html>
