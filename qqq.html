<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Quét Mã & Gửi Google Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f9f9f9;
      touch-action: pan-y;
    }
    .wrapper {
      display: flex;
      width: 200vw;
      transition: transform 0.3s ease;
    }
    .panel {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 1em;
      overflow-y: auto;
    }
    h2 {
      margin: 0.5em 0;
      text-align: center;
    }
    video {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      background: black;
    }
    select, button, textarea {
      width: 100%;
      max-width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    textarea {
      height: 90px;
      resize: none;
      overflow-y: auto;
    }
    #statusMsg {
      color: green;
      font-size: 0.9em;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      font-size: 0.9em;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 4px;
      text-align: center;
    }
    @media (hover: hover) and (pointer: fine) {
      body::before {
        content: "Chỉ hỗ trợ trên thiết bị di động";
        display: block;
        background: red;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
      }
      .wrapper { display: none; }
    }
  </style>
</head>
<body>
<div class="wrapper" id="wrapper">
  <div class="panel">
    <h2>Quét mã</h2>
    <select id="userSelect"></select>
    <video id="video" playsinline></video>
    <textarea id="resultArea" placeholder="Các mã đã quét..."></textarea>
    <button onclick="submitData()">Gửi lên Google Sheet</button>
    <div id="statusMsg"></div>
  </div>
  <div class="panel">
    <h2>Dữ liệu đã ghi</h2>
    <table>
      <thead><tr><th>Thời gian</th><th>Mã</th><th>Người</th></tr></thead>
      <tbody id="data-body"></tbody>
    </table>
  </div>
</div>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbxgdO3DI_3GB-4xV8Zv8d5aG7hdBB_j7roe7zoy9Tx-DMRp_RkTGSqqUqAufuMOOrM/exec";
const wrapper = document.getElementById("wrapper");
let currentPanel = 0, startX = 0;
let codeReader, scanned = new Set();

async function loadUsers() {
  const res = await fetch(sheetAPI + "?action=getUsers");
  const json = await res.json();
  const select = document.getElementById("userSelect");
  select.innerHTML = json.users.map(u => `<option>${u}</option>`).join("");
}

function startScanner() {
  codeReader = new ZXing.BrowserMultiFormatReader();
  codeReader.listVideoInputDevices().then(devices => {
    let cam = devices.find(d => /back|environment/i.test(d.label)) || devices[0];
    return codeReader.decodeFromVideoDevice(cam.deviceId, "video", (result, err) => {
      if (result) {
        let val = result.text.trim();
        if (!scanned.has(val)) {
          scanned.add(val);
          document.getElementById("resultArea").value += val + "\n";
        }
      }
    });
  });
}

function submitData() {
  let codes = document.getElementById("resultArea").value.trim().split("\n").filter(n => n);
  if (!codes.length) return alert("Không có mã để gửi.");
  let user = document.getElementById("userSelect").value;
  fetch(sheetAPI, {
    method: "POST",
    body: JSON.stringify({ codes, user }),
    headers: {"Content-Type": "application/json"}
  }).then(res => res.json()).then(res => {
    if (res.status === "ok") {
      document.getElementById("statusMsg").innerText = `Gửi thành công ${res.added} mã.`;
      document.getElementById("resultArea").value = "";
      scanned.clear();
    } else alert("Gửi thất bại.");
  });
}

wrapper.addEventListener("touchstart", e => startX = e.touches[0].clientX);
wrapper.addEventListener("touchend", e => {
  let deltaX = e.changedTouches[0].clientX - startX;
  if (deltaX < -50 && currentPanel === 0) currentPanel = 1;
  else if (deltaX > 50 && currentPanel === 1) currentPanel = 0;
  wrapper.style.transform = `translateX(-${currentPanel * 100}vw)`;
});

function updateTable() {
  fetch(sheetAPI + "?action=getData").then(res => res.json()).then(json => {
    const tbody = document.getElementById("data-body");
    tbody.innerHTML = "";
    json.data.slice(1).reverse().forEach(row => {
      let tr = document.createElement("tr");
      row.forEach(cell => {
        let td = document.createElement("td");
        td.innerText = cell;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  });
}

if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
  loadUsers();
  startScanner();
  updateTable();
  setInterval(updateTable, 10000);
} else {
  document.body.innerHTML = "<h2 style='color:red;text-align:center;padding:20px'>Trang này chỉ hoạt động trên thiết bị di động</h2>";
}
</script>
</body>
</html>
