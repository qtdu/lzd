<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quét mã & Gửi Google Sheet</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #reader {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      overflow-y: auto;
    }
    textarea {
      width: 100%;
      height: 100px;
      resize: none;
      margin-top: 10px;
      overflow-y: scroll;
    }
    input, button, select {
      padding: 8px;
      font-size: 16px;
      margin: 5px 0;
      width: 100%;
      max-width: 480px;
    }
    .popup {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>

<div id="reader"></div>

<div class="container">
  <label>Người quét:
    <select id="scanner-name">
      <option value="">-- Chọn người quét --</option>
    </select>
  </label>

  <select id="camera-select"></select>

  <textarea id="code-list" readonly></textarea>

  <button id="send-btn">Gửi lên Google Sheet</button>
</div>

<div id="popup" class="popup"></div>

<script>
const sheetAPI = "https://script.google.com/macros/s/AKfycbwIoE73kjV9ECgM8Us975CulMQginzJzHTrk_LW07vdiN3rBgnx5O-gfXnpOnDIr2M/exec"; // Dán URL Apps Script của bạn vào đây
const scannedCodes = new Set();
const textarea = document.getElementById("code-list");
const sendBtn = document.getElementById("send-btn");
const scannerNameInput = document.getElementById("scanner-name");
const popup = document.getElementById("popup");
const cameraSelect = document.getElementById("camera-select");

let html5QrcodeScanner;
let currentCameraId = null;
let isSending = false;

function updateTextarea() {
  textarea.value = Array.from(scannedCodes).join("\n");
}

function showPopup(msg, time = 2500) {
  popup.innerText = msg;
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", time);
}

function onScanSuccess(decodedText) {
  if (!scannedCodes.has(decodedText)) {
    scannedCodes.add(decodedText);
    updateTextarea();
  }
}

function startScanner(cameraId) {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      initScanner(cameraId);
    });
  } else {
    initScanner(cameraId);
  }
}

function initScanner(cameraId) {
  html5QrcodeScanner = new Html5Qrcode("reader");
  html5QrcodeScanner.start(
    cameraId,
    { fps: 10, qrbox: 250 },
    onScanSuccess
  ).catch(err => {
    showPopup("Không thể bật camera: " + err);
  });
}

Html5Qrcode.getCameras().then(devices => {
	if (devices.length === 0) return showPopup("Không có camera nào!");
  devices.forEach((d, i) => {
    const option = document.createElement("option");
    option.value = d.id;
    option.text = d.label || `Camera ${i + 1}`;
    if (/back|rear/i.test(d.label)) option.selected = true;
    cameraSelect.appendChild(option);
  });
  currentCameraId = cameraSelect.value;
  startScanner(currentCameraId);
}).catch(err => {
  showPopup("Lỗi truy cập camera: " + err);
});

cameraSelect.addEventListener("change", () => {
  const selectedId = cameraSelect.value;
  if (selectedId !== currentCameraId) {
    currentCameraId = selectedId;
    startScanner(currentCameraId);
  }
});

sendBtn.addEventListener("click", () => {
  if (isSending) return;
  const name = scannerNameInput.value.trim();
  if (!name) return showPopup("Vui lòng chọn người quét!");

  const data = Array.from(scannedCodes);
  if (data.length === 0) return showPopup("Chưa có mã nào để gửi!");

  isSending = true;
  sendBtn.disabled = true;

  const formData = new FormData();
  formData.append("name", name);
  formData.append("codes", JSON.stringify(data));

  fetch(sheetAPI, {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === "ok") {
      showPopup(`Đã gửi ${res.added}/${res.total} mã`);
      scannedCodes.clear();
      updateTextarea();
    } else {
      showPopup("Lỗi: " + res.message);
    }
  })
  .catch(err => {
    showPopup("Lỗi gửi: " + err.message);
  })
  .finally(() => {
    isSending = false;
    sendBtn.disabled = false;
  });
});

// Tải danh sách tên từ sheet "Danh sách"
function loadUsers() {
  fetch(sheetAPI)
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        const select = document.getElementById("scanner-name");
        data.users.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.text = name;
          select.appendChild(opt);
        });
      } else {
        showPopup("Không tải được danh sách tên!");
      }
    })
    .catch(err => {
      showPopup("Lỗi kết nối danh sách tên: " + err.message);
    });
}

loadUsers();
</script>

</body>
</html>